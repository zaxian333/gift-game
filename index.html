<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ğŸ„ äº¤æ›ç¦®ç‰©æ´¾å° Â· Christmas v2.8 (UMD+Fallback)</title>
<meta name="theme-color" content="#0b1329">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{ --bg0:#0b1329; --bg1:#0f1f45; --bg2:#11234a; --card:#10234c; --border:rgba(255,255,255,.14);
       --text:#eaf4ff; --sub:#bcd7ff; --brand:#46e7c2; --accent:#ff5f73; }
*{box-sizing:border-box} html,body{height:100%} body{ margin:0; color:var(--text);
font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial;
background: radial-gradient(1200px 800px at 10% -10%, rgba(255,255,255,.06), transparent 40%),
            radial-gradient(1200px 800px at 50% -10%, rgba(255,255,255,.05), transparent 40%),
            linear-gradient(180deg, #0b1329, #0e1b3d); overflow-x:hidden; }
.wrap{max-width:1060px; margin:24px auto; padding:0 18px 80px}
.header{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
.h-title{font-size:28px; font-weight:800; letter-spacing:.5px}
.badge{background:#1a2f63; border:1px solid var(--border); color:var(--sub); padding:6px 10px; border-radius:12px}
.card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; margin:14px 0; box-shadow:0 10px 30px rgba(0,0,0,.18)}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
input,select,button{background:#0f214a; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px 12px; outline:none}
input::placeholder{color:#9bb6ff80}
.btn{cursor:pointer; transition:.15s ease; user-select:none}
.btn:hover{transform:translateY(-1px)}
.btn-ok{background:#0f2f3f; border-color:#1d7; }
.btn-pink{background:#41203a; border-color:#f59; }
.kbd{font:13px ui-monospace,Menlo,Consolas,monospace; background:#0b1a3d; border:1px solid var(--border); padding:3px 7px; border-radius:7px}
.small{font-size:13px; color:var(--sub)}
ul{margin:6px 0 0 18px; padding:0}
hr.sep{border:0; height:1px; background:linear-gradient(90deg, transparent, var(--border), transparent); margin:10px 0}
.snow { position: fixed; inset:0; pointer-events:none; z-index:0; }
.snow span{ position:absolute; top:-10px; width:6px; height:6px; background:#fff; border-radius:50%; opacity:.75; filter:blur(.5px); animation:fall linear infinite; }
@keyframes fall{ to{ transform:translateY(110vh) } }
.toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#142a59; color:#fff;
         border:1px solid var(--border); padding:10px 14px; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.3);
         display:none; z-index:5; max-width:90vw; font-size:14px }
.hidden{display:none}
</style>
</head>
<body>
<div class="snow" id="snow"></div>
<div class="wrap">
  <div class="header">
    <div class="h-title">ğŸ„ äº¤æ›ç¦®ç‰©æ´¾å° Â· <span class="badge">è“‹ç‰ŒåŒç¿»</span> <span class="badge">æ’è»Šï¼å¤§è™Ÿå‹</span> <span class="badge">Christmas v2.8</span></div>
  </div>
  <p class="small">æç¤ºï¼šè‹¥ä½ æœ‹å‹è£äº†å¤–æ›å°è‡´æŒ‰éˆ•æ²’åæ‡‰ï¼Œè«‹æ”¹ç”¨ <span class="kbd">safe.html</span> å®‰å…¨æ¨¡å¼ç¶²å€ï¼›æœ¬é ä¹Ÿå…§å»º <b>localStorage é˜²å‘†</b> èˆ‡ <b>Realtime â†’ è¼ªè©¢ fallback</b>ã€‚</p>

  <div class="card">
    <h3>0) é€£ç·šè¨­å®š</h3>
    <div class="row">
      <label>SUPABASE_URL <input id="SUPABASE_URL" size="36" value="https://qcbhhfvkfjpazchaixzz.supabase.co"/></label>
      <label>ANON_KEY <input id="SUPABASE_ANON_KEY" size="54" value="sb_publishable_WmO0PJW-WGP5kNNBJiAZtA_5hIdbr0x"/></label>
      <button class="btn btn-ok" id="saveKeys">å„²å­˜åˆ°ç€è¦½å™¨</button>
      <button class="btn btn-pink" id="btnTest">æ¸¬è©¦é€£ç·š</button>
    </div>
  </div>

  <div class="card">
    <h3>1) ä¸»æŒäººï½œå»ºç«‹æˆ¿é–“</h3>
    <div class="row">
      <input id="totalPlayers" type="number" min="2" max="100" value="8" placeholder="ç¸½äººæ•¸ N"/>
      <button class="btn btn-ok" id="btnCreate" onclick="window.__createRoom && __createRoom()">å»ºç«‹ 6 ä½æ•¸å­—æˆ¿è™Ÿ</button>
      <button class="btn btn-pink" id="btnEnd" disabled onclick="window.__reveal && __reveal()">å…¬å¸ƒçµæœï¼ˆåŒç¿»ï¼‰</button>
    </div>
    <div id="hostInfo" class="small" style="margin-top:8px"></div>
    <div id="capacityInfo" class="small"></div>
    <hr class="sep">
    <h4>ç©å®¶åå–®</h4>
    <div id="playersBox"></div>
    <h4>å·ç‰Œç‹€æ…‹</h4>
    <div id="picksBox"></div>
  </div>

  <div class="card">
    <h3>2) ç©å®¶åŠ å…¥æˆ¿é–“</h3>
    <div class="row">
      <input id="joinCode" inputmode="numeric" pattern="\\d*" placeholder="è¼¸å…¥ 6 ä½æ•¸å­—æˆ¿è™Ÿ" maxlength="6"/>
      <input id="playerName" placeholder="ä½ çš„åå­—"/>
      <button class="btn btn-ok" id="btnJoin" onclick="window.__joinRoom && __joinRoom()">åŠ å…¥</button>
    </div>
    <div id="meBox" class="small" style="margin-top:8px"></div>
    <div id="pickUI" class="hidden" style="margin-top:12px">
      <h4>3) è“‹ç‰Œå·ç‰Œ</h4>
      <div class="row">
        <label>æƒ³å·çš„åº§ä½ï¼š<select id="targetSelect"></select></label>
        <button class="btn btn-ok" id="btnPick" onclick="window.__sendPick && __sendPick()">é€å‡ºï¼ˆå¯è¦†è“‹ï¼‰</button>
      </div>
    </div>
  </div>

  <div class="card hidden" id="resultCard">
    <h3>4) çµæœ</h3>
    <div id="resultBox"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(function snow(){
  const c = document.getElementById('snow');
  for(let i=0;i<120;i++){
    const s = document.createElement('span');
    s.style.left = Math.random()*100 + 'vw';
    s.style.animationDuration = 6 + Math.random()*8 + 's';
    s.style.animationDelay = Math.random()*6 + 's';
    s.style.opacity = 0.5 + Math.random()*0.5;
    c.appendChild(s);
  }
})();

const toastEl=document.querySelector('#toast');
function toast(m){ toastEl.textContent=m; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',4200); }

const LS = (() => {
  try { const t = window.localStorage; t.setItem('__t','1'); t.removeItem('__t'); return t; }
  catch (e) { const mem = new Map(); return { getItem:k=>mem.get(k)??null, setItem:(k,v)=>mem.set(k,String(v)), removeItem:k=>mem.delete(k) }; }
})();

const urlInput=document.querySelector('#SUPABASE_URL');
const keyInput=document.querySelector('#SUPABASE_ANON_KEY');
document.querySelector('#saveKeys').addEventListener('click',()=>{ LS.setItem('SB_URL', urlInput.value.trim()); LS.setItem('SB_KEY', keyInput.value.trim()); toast('å·²å„²å­˜åˆ°ç€è¦½å™¨'); });

let supa=null, room=null, me=null, allPicks=[];
const hostInfo=document.querySelector('#hostInfo');
const capacityInfo=document.querySelector('#capacityInfo');
const playersBox=document.querySelector('#playersBox');
const picksBox=document.querySelector('#picksBox');
const resultCard=document.querySelector('#resultCard');
const resultBox=document.querySelector('#resultBox');

function connect(){
  const url=(urlInput.value||LS.getItem('SB_URL')||'').trim();
  const key=(keyInput.value||LS.getItem('SB_KEY')||'').trim();
  if(!url||!key){ toast('è«‹å…ˆå¡« URL èˆ‡ ANON KEY'); return null; }
  supa = window.supabase.createClient(url,key);
  return supa;
}

document.querySelector('#btnTest').addEventListener('click', async ()=>{
  if(!connect())return;
  const {error}=await supa.from('rooms').select('count',{count:'exact',head:true});
  toast(error?('Key æ¸¬è©¦å¤±æ•—ï¼š'+error.message):'Key æ¸¬è©¦æˆåŠŸ');
});

function esc(s){return (s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[c]))}
function statusSecret(p){return p.submitted?'<b>å·²é€å‡º</b>':'<span class=\"small\">å°šæœªé¸æ“‡</span>'}
function statusReveal(p){return (p.target===0)?'<span class=\"small\">PASS</span>':'#'+p.target}
function getDeviceId(){ let id=LS.getItem('DEVICE_ID'); if(!id){ id=(Date.now().toString(36)+'-'+Math.random().toString(36).slice(2)); LS.setItem('DEVICE_ID', id); } return id; }
function genCode(n){ let s=''; for(let i=0;i<n;i++) s+=Math.floor(Math.random()*10); return s; }

function renderHost(){
  if(!room){ hostInfo.textContent=''; playersBox.innerHTML=''; picksBox.innerHTML=''; capacityInfo.textContent=''; return }
  const sorted=[...allPicks].sort((a,b)=>a.seat-b.seat);
  const showReal=room.status==='revealed';
  const N = room.total_players || Math.max(sorted.length,1);
  const used = new Set(sorted.map(p=>p.seat));
  const remain = Array.from({length:N}, (_,i)=>i+1).filter(n=>!used.has(n));
  capacityInfo.textContent = `å·²åŠ å…¥ ${sorted.length}/${N}ï¼›å‰©é¤˜åº§ä½ï¼š` + (remain.length?('#'+remain.join('ã€#')):'ï¼ˆæ»¿ï¼‰');
  playersBox.innerHTML = '<ul>'+sorted.map(p=>`<li>#${p.seat} - ${esc(p.name)}</li>`).join('')+'</ul>';
  picksBox.innerHTML = '<ul>'+sorted.map(p=>`<li>#${p.seat} - ${esc(p.name)} ï½œ ${showReal?statusReveal(p):statusSecret(p)}</li>`).join('')+'</ul>';
  document.querySelector('#btnEnd').disabled=(allPicks.length===0);
  hostInfo.innerHTML = `æˆ¿è™Ÿ <span class=\"kbd\">${room.code}</span> ï½œ ç‹€æ…‹ï¼š${room.status} ï½œ äººæ•¸ï¼š${room.total_players||'?'}`;
}

function renderPlayer(){
  const meBox=document.querySelector('#meBox'), pickUI=document.querySelector('#pickUI'), targetSel=document.querySelector('#targetSelect');
  if(!me){ meBox.textContent=''; pickUI.classList.add('hidden'); return }
  meBox.innerHTML=`ä½ æ˜¯ <b>#${me.seat}</b>ãƒ»${esc(me.name)} ï½œ æˆ¿è™Ÿ <span class='kbd'>${room.code}</span>`;
  pickUI.classList.remove('hidden');
  const N = room?.total_players || Math.max(...allPicks.map(p=>p.seat), me.seat, 1);
  targetSel.innerHTML = '<option value=\"0\">PASS</option>' + Array.from({length:N},(_,i)=>i+1).map(n=>`<option value=\"${n}\" ${me.target===n?'selected':''}>#${n}</option>`).join('');
}

async function createRoom(){
  if(!connect())return;
  const N = Math.max(2, Math.min(100, parseInt(document.querySelector('#totalPlayers').value||'8',10) || 8));
  const code = genCode(6);
  const {data,error} = await supa.from('rooms').insert({code,status:'picking', total_players:N}).select().single();
  if(error){toast('å»ºæˆ¿å¤±æ•—ï¼š'+error.message);return}
  room=data; subscribeRoom(room.id); subscribePicks(room.id); renderHost(); toast(`æˆ¿é–“å»ºç«‹æˆåŠŸï¼ˆäººæ•¸ ${N}ï¼‰`);
}

async function joinRoom(){
  if(!connect())return;
  const raw=(document.querySelector('#joinCode').value||new URL(location.href).searchParams.get('code')||'').trim();
  const code = raw.replace(/\\D/g,'');
  const name=(document.querySelector('#playerName').value||'').trim();
  if(!code||code.length!==6){toast('è«‹è¼¸å…¥ 6 ä½æ•¸å­—æˆ¿è™Ÿ');return}
  if(!name){toast('è«‹è¼¸å…¥åå­—');return}
  const {data:r,error:e1}=await supa.from('rooms').select('*').eq('code',code).single();
  if(e1||!r){toast('æ‰¾ä¸åˆ°æˆ¿é–“');return}
  room=r; subscribeRoom(room.id); subscribePicks(room.id);

  const N = room.total_players || 0;
  if(!N){ toast('æ­¤æˆ¿æœªè¨­å®šç¸½äººæ•¸ï¼Œè«‹ä¸»æŒäººé‡æ–°å»ºæˆ¿'); return }

  const deviceId=getDeviceId();
  const {data:exist}=await supa.from('picks').select('*').eq('room_id',room.id).eq('device_id',deviceId).maybeSingle();
  if(exist){ me=exist; renderPlayer(); renderHost(); toast(`æœ¬è£ç½®å·²åŠ å…¥ï¼Œè™Ÿç¢¼æ˜¯ #${exist.seat}`); return }

  const {data:picks}=await supa.from('picks').select('seat').eq('room_id',room.id);
  const usedSet = new Set((picks||[]).map(p=>p.seat));
  const remain = Array.from({length:N}, (_,i)=>i+1).filter(n=>!usedSet.has(n));
  if(remain.length===0){ toast('æœ¬æˆ¿å·²é¡æ»¿ï¼Œç„¡æ³•åŠ å…¥'); return }

  const seat = remain[Math.floor(Math.random()*remain.length)];
  const {data:mine,error:e2}=await supa.from('picks').insert({room_id:room.id, seat, name, target:0, submitted:false, device_id:deviceId}).select().single();
  if(e2){toast('åŠ å…¥å¤±æ•—ï¼š'+e2.message);return}
  me=mine; renderPlayer(); renderHost(); toast(`åŠ å…¥æˆåŠŸï¼Œä½ çš„è™Ÿç¢¼æ˜¯ #${seat}`);
}

async function sendPick(){
  if(!supa||!me){toast('å°šæœªåŠ å…¥');return}
  const t=+document.querySelector('#targetSelect').value;
  const payload={room_id:me.room_id, seat:me.seat, name:me.name, target:t, submitted:true, device_id:me.device_id};
  const {data,error}=await supa.from('picks').upsert(payload, { onConflict: 'room_id,seat' }).select().single();
  if(error){toast('é€å‡ºå¤±æ•—ï¼š'+error.message);return}
  me=data; renderPlayer();
}

async function reveal(){
  if(!supa||!room)return;
  const {data:picks,error}=await supa.from('picks').select('*').eq('room_id',room.id);
  if(error){toast('è®€å–å¤±æ•—ï¼š'+error.message);return}
  const groups=new Map(); for(const p of picks){ const t=p.target||0; if(t>0){ if(!groups.has(t))groups.set(t,[]); groups.get(t).push(p.seat) } }
  const successes=[], logs=[];
  for(const [target,seats] of groups){ 
    if(seats.length>=2){ const winner=Math.max(...seats); successes.push({thief:winner,target}); const losers=seats.filter(s=>s!==winner); logs.push(`å¤šäººç„æº– #${target} â†’ <b>#${winner} æˆåŠŸ</b>ï¼ˆå¤§è™Ÿå‹ï¼‰ï¼Œ${losers.map(s=>'#'+s).join('ã€')} å¤±æ•—`) }
    else if(seats.length===1){ successes.push({thief:seats[0],target}); logs.push(`å–®ç¨ç„æº– #${target} â†’ <b>#${seats[0]} æˆåŠŸ</b>`) }
  }
  const N = room.total_players || picks.length;
  const holding=Array.from({length:N+1},(_,i)=>i);
  for(const {thief,target} of successes){ const tg=holding[target]; const th=holding[thief]; holding[target]=th; holding[thief]=tg }
  const result={logs,successes,after:holding};
  const {error:e2}=await supa.from('rooms').update({status:'revealed', result_json:result}).eq('id',room.id);
  if(e2){toast('æ›´æ–°çµæœå¤±æ•—ï¼š'+e2.message)}
}

window.__createRoom = createRoom;
window.__joinRoom   = joinRoom;
window.__sendPick   = sendPick;
window.__reveal     = reveal;

function subscribeRoom(room_id){
  let liveOK = false;
  supa.channel('rooms:'+room_id)
    .on('postgres_changes',{event:'*',schema:'public',table:'rooms',filter:`id=eq.${room_id}`},payload=>{
      room=payload.new; if(room?.status==='revealed'&&room.result_json) showResult(room.result_json); renderHost();
    })
    .subscribe(status=>{ if(status==='SUBSCRIBED') liveOK=true; });
  setTimeout(async()=>{
    if(!liveOK){
      setInterval(async()=>{
        const {data} = await supa.from('rooms').select('*').eq('id',room_id).single();
        if(data){ room=data; if(room?.status==='revealed'&&room.result_json) showResult(room.result_json); renderHost(); }
      }, 2500);
    }
  }, 3000);
}
function subscribePicks(room_id){
  let liveOK = false;
  supa.channel('picks:'+room_id)
    .on('postgres_changes',{event:'*',schema:'public',table:'picks',filter:`room_id=eq.${room_id}`}, async ()=>{
      const {data}=await supa.from('picks').select('*').eq('room_id',room_id); allPicks=data||[]; renderHost(); renderPlayer();
    })
    .subscribe(status=>{ if(status==='SUBSCRIBED') liveOK=true; });
  setTimeout(()=>{
    if(!liveOK){
      setInterval(async()=>{
        const {data}=await supa.from('picks').select('*').eq('room_id',room_id); allPicks=data||[]; renderHost(); renderPlayer();
      }, 2000);
    }
  }, 3000);
}

function showResult(r){
  resultCard.classList.remove('hidden');
  resultBox.innerHTML = '<ol>' + (r.logs||[]).map(x=>'\\n<li>'+x+'</li>').join('') + '</ol>';
}

window.addEventListener('error', e => toast('éŒ¯èª¤ï¼š'+(e.message||'æœªçŸ¥')));
window.addEventListener('unhandledrejection', e => toast('Promise éŒ¯èª¤ï¼š'+(e.reason?.message||e.reason||'æœªçŸ¥')));
</script>
</body>
</html>
